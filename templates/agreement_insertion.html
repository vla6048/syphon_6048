{% extends 'base.html' %}

{% block title %}Добавить договор{% endblock %}

{% block content %}
<h1>Добавить новый договор</h1>
<form id="agreementForm" method="POST" action="{{ url_for('submit_agreement') }}">
    <div class="form-group">
        <label for="agreement_name">Название договора:</label>
        <input type="text" class="form-control" id="agreement_name" name="agreement_name" required>
    </div>

    <div class="form-group">
        <label for="master_name">Мастер:</label>
        <input type="text" class="form-control" id="master_name" name="master_name" autocomplete="off" required>
        <input type="hidden" id="master_id" name="master_id">
        <div id="master_suggestions" class="list-group"></div>
    </div>

    <div class="form-group">
        <label for="engineer">Инженер:</label>
        <select id="engineer" class="form-control" name="engineer" required>
            {% for engineer in engineers %}
            <option value="{{ engineer[0] }}">{{ engineer[1] }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="agreement_date">Дата договора:</label>
        <input type="date" class="form-control" id="agreement_date" name="agreement_date" required>
    </div>

    <button type="submit" class="btn btn-primary">Сохранить</button>
</form>
{% endblock %}

{% block scripts %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $(document).ready(function() {
        // Обработчик для автозаполнения поля "Мастер"
        $('#master_name').on('input', function() {
            const query = $(this).val();
            if (query.length > 1) {
                $.ajax({
                    url: "{{ url_for('search_masters') }}",
                    method: "GET",
                    data: { query: query },
                    success: function(data) {
                        $('#master_suggestions').empty();
                        data.forEach(function(master) {
                            $('#master_suggestions').append(`<a href="#" class="list-group-item list-group-item-action suggestion" data-id="${master.id}">${master.name}</a>`);
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error("AJAX error: ", status, error);
                    }
                });
            } else {
                $('#master_suggestions').empty();
            }
        });

        // Выбор мастера из предложений
        $('#master_suggestions').on('click', '.suggestion', function(event) {
            event.preventDefault();
            const masterId = $(this).data('id');
            const masterName = $(this).text();
            $('#master_name').val(masterName);
            $('#master_id').val(masterId);
            $('#master_suggestions').empty();
        });
    });
</script>
{% endblock %}
