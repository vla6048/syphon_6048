{% extends "base.html" %}

{% block title %}Внесение оборудования{% endblock %}

{% block content %}
<h2>Внесение оборудования</h2>

<form id="equipmentForm" method="post">
    <!-- Выбор типа оборудования -->
    <div class="form-group">
        <label for="equipmentType">Тип оборудования</label>
        <select id="equipmentType" name="type_id" class="form-control" required>
            <option value="">Выберите тип</option>
            {% for type in equipment_types %}
                <option value="{{ type[0] }}" data-related-table="{{ type[2] }}">{{ type[1] }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Поле для серийного номера -->
    <div class="form-group">
        <label for="serialNumber">Серийный номер</label>
        <input type="text" id="serialNumber" name="sn" class="form-control">
        <small id="snWarning" class="text-danger d-none">Этот серийный номер уже существует!</small>
    </div>

    <!-- Чекбокс "Без серийного номера" -->
    <div class="form-group">
        <input type="checkbox" id="noSnCheckbox" name="no_sn">
        <label for="noSnCheckbox">Без серийного номера</label>
    </div>

    <!-- Поля для состояния и примечания -->
    <div class="form-group">
        <label for="state">Состояние</label>
        <select id="state" name="state" class="form-control">
            <option value="new">Новое</option>
            <option value="used">Использованное</option>
            <option value="defected">Неисправное</option>
        </select>
    </div>

    <div class="form-group">
        <label for="remark">Примечание</label>
        <textarea id="remark" name="remark" class="form-control"></textarea>
    </div>

    <!-- Динамические поля -->
    <div id="dynamicFieldsContainer" class="d-none">
        <h4>Дополнительные параметры</h4>
        <div id="dynamicFields"></div>
    </div>

    <!-- Кнопка отправки -->
    <button type="submit" id="submitButton" class="btn btn-primary">Внести</button>
</form>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const equipmentTypeSelect = document.getElementById("equipmentType");
    const snCheckbox = document.getElementById("noSnCheckbox");
    const snInput = document.getElementById("serialNumber");
    const snWarning = document.getElementById("snWarning");
    const submitButton = document.getElementById("submitButton");
    const dynamicFieldsContainer = document.getElementById("dynamicFieldsContainer");
    const dynamicFields = document.getElementById("dynamicFields");

    // Отключение серийного номера при выборе "Без серийного номера"
    snCheckbox.addEventListener("change", function () {
        if (this.checked) {
            snInput.disabled = true;
            snInput.value = "";
            snWarning.classList.add("d-none");
            submitButton.disabled = false;
        } else {
            snInput.disabled = false;
        }
    });

    // Проверка серийного номера в БД
    snInput.addEventListener("input", function () {
        const sn = snInput.value.trim();
        if (sn.length > 0) {
            fetch(`/check_sn?sn=${sn}`)
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        snWarning.classList.remove("d-none");
                        submitButton.disabled = true;
                    } else {
                        snWarning.classList.add("d-none");
                        submitButton.disabled = false;
                    }
                })
                .catch(error => console.error("Ошибка проверки SN:", error));
        } else {
            snWarning.classList.add("d-none");
            submitButton.disabled = false;
        }
    });

    // Загрузка динамических полей при выборе типа оборудования
    equipmentTypeSelect.addEventListener("change", function () {
        const selectedOption = equipmentTypeSelect.options[equipmentTypeSelect.selectedIndex];
        const relatedTable = selectedOption.dataset.relatedTable;

        if (relatedTable) {
            fetch(`/get_fields/${relatedTable}`)
                .then(response => response.json())
                .then(fields => {
                    dynamicFields.innerHTML = "";
                    if (fields.length > 0) {
                        dynamicFieldsContainer.classList.remove("d-none");
                        fields.forEach(field => {
                            const formGroup = document.createElement("div");
                            formGroup.className = "form-group";
                            formGroup.innerHTML = `
                                <label for="${field}">${field}</label>
                                <input type="text" id="${field}" name="${field}" class="form-control">
                            `;
                            dynamicFields.appendChild(formGroup);
                        });
                    } else {
                        dynamicFieldsContainer.classList.add("d-none");
                    }
                })
                .catch(error => console.error("Ошибка загрузки полей:", error));
        } else {
            dynamicFieldsContainer.classList.add("d-none");
            dynamicFields.innerHTML = "";
        }
    });
});
</script>
{% endblock %}
